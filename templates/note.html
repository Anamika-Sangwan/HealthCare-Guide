<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Medical Voice Notes</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/enhanced-medical-notes.css') }}">
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i data-feather="heart" class="text-danger me-2"></i> Health Companion
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/note">Note Appointment</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/symptom_checker">Symptom Checker</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/lipid_profile">Lipid Profile</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/chatbot">Health Chatbot</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-lg-10 col-md-12">
                <div class="card shadow-soft">
                    <div class="card-header">
                        <h2>Medical Voice Notes</h2>
                    </div>
                    <div class="card-body">
                        <div class="controls">
                            <button id="start-btn" class="btn btn-outline-primary">
                                <i data-feather="play"></i> Start Recording
                            </button>
                            <button id="stop-btn" class="btn btn-outline-primary">
                                <i data-feather="pause" class="text-danger"></i> Stop Recording
                            </button>
                            <button id="save-btn" class="btn btn-outline-primary">
                                <i data-feather="save"></i> Save Note
                            </button>
                        </div>
                        
                        <div id="transcript" contenteditable="true" placeholder="Start speaking or type your medical notes here..."></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <h2>
                    <i data-feather="archive"></i> Saved Notes
                </h2>
                <div id="notes-container">
                    <!-- Notes will be loaded here dynamically -->
                </div>
            </div>
        </div>
    </div>
    <script>
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const transcriptDiv = document.getElementById('transcript');
        const saveBtn = document.getElementById('save-btn');
        const notesContainer = document.getElementById('notes-container');

        let recognition;
        let isRecording = false;
        let finalTranscript = '';

        // Load existing notes when page loads
        window.addEventListener('DOMContentLoaded', loadNotes);

        function loadNotes() {
            fetch('/get_notes')
                .then(response => response.json())
                .then(notes => {
                    notesContainer.innerHTML = '';
                    notes.forEach(note => {
                        createNoteCard(note);
                    });
                })
                .catch(error => console.error('Error loading notes:', error));
        }

        function createNoteCard(noteData) {
            const noteCard = document.createElement('div');
            noteCard.className = 'note-card';
            
            // Create summary section
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'note-summary';
            
            // Age display
            if (noteData.summary.age) {
                const ageSpan = document.createElement('span');
                ageSpan.className = 'info-tag age';
                ageSpan.textContent = `Age: ${noteData.summary.age}`;
                summaryDiv.appendChild(ageSpan);
            }
            
            // Name display
            if (noteData.summary.name) {
                const nameSpan = document.createElement('span');
                nameSpan.className = 'info-tag name';
                nameSpan.textContent = `Name: ${noteData.summary.name}`;
                summaryDiv.appendChild(nameSpan);
            }
            
            // Symptoms display
            if (noteData.summary.symptoms && noteData.summary.symptoms.length > 0) {
                const symptomsDiv = document.createElement('div');
                symptomsDiv.className = 'symptoms-container';
                
                const symptomsLabel = document.createElement('span');
                symptomsLabel.className = 'info-label';
                symptomsLabel.textContent = 'Symptoms:';
                symptomsDiv.appendChild(symptomsLabel);
                
                const symptomsList = document.createElement('div');
                symptomsList.className = 'tags-list';
                
                noteData.summary.symptoms.forEach(symptom => {
                    const symptomTag = document.createElement('span');
                    symptomTag.className = 'info-tag symptom';
                    symptomTag.textContent = symptom;
                    symptomsList.appendChild(symptomTag);
                });
                
                symptomsDiv.appendChild(symptomsList);
                summaryDiv.appendChild(symptomsDiv);
            }
            
            // Family history display
            if (noteData.summary.family_history && noteData.summary.family_history.length > 0) {
                const historyDiv = document.createElement('div');
                historyDiv.className = 'history-container';
                
                const historyLabel = document.createElement('span');
                historyLabel.className = 'info-label';
                historyLabel.textContent = 'Family History:';
                historyDiv.appendChild(historyLabel);
                
                noteData.summary.family_history.forEach(history => {
                    const historyItem = document.createElement('p');
                    historyItem.className = 'history-item';
                    historyItem.textContent = history;
                    historyDiv.appendChild(historyItem);
                });
                
                summaryDiv.appendChild(historyDiv);
            }
            
            // Possible Diseases display
            if (noteData.summary.possible_diseases && noteData.summary.possible_diseases.length > 0) {
                const diseasesDiv = document.createElement('div');
                diseasesDiv.className = 'diseases-container';
                
                const diseasesLabel = document.createElement('span');
                diseasesLabel.className = 'info-label';
                diseasesLabel.textContent = 'Possible Conditions:';
                diseasesDiv.appendChild(diseasesLabel);
                
                const diseasesList = document.createElement('div');
                diseasesList.className = 'tags-list';
                
                noteData.summary.possible_diseases.forEach(disease => {
                    const diseaseTag = document.createElement('span');
                    diseaseTag.className = 'info-tag disease';
                    diseaseTag.textContent = disease;
                    diseasesList.appendChild(diseaseTag);
                });
                
                diseasesDiv.appendChild(diseasesList);
                summaryDiv.appendChild(diseasesDiv);
            }
            
            // Original note text
            const originalDiv = document.createElement('div');
            originalDiv.className = 'original-note';
            originalDiv.textContent = noteData.original;
            
            // Toggle button to show/hide full note
            const toggleBtn = document.createElement('button');
            toggleBtn.className = 'toggle-note';
            toggleBtn.textContent = 'Show Full Note';
            toggleBtn.onclick = function() {
                const isVisible = originalDiv.style.display === 'block';
                originalDiv.style.display = isVisible ? 'none' : 'block';
                toggleBtn.textContent = isVisible ? 'Show Full Note' : 'Hide Full Note';
            };
            
            // Add all elements to note card
            noteCard.appendChild(summaryDiv);
            noteCard.appendChild(toggleBtn);
            noteCard.appendChild(originalDiv);
            
            // Add card to container
            notesContainer.prepend(noteCard);
        }

        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onresult = function(event) {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                transcriptDiv.innerText = finalTranscript + interimTranscript;
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                alert('Speech recognition error: ' + event.error);
            };
            
            recognition.onend = function() {
                console.log('Speech recognition ended');
                isRecording = false;
                startBtn.classList.remove('active');
            };
        } else {
            alert("Speech Recognition is not supported in this browser.");
        }

        startBtn.onclick = function() {
            console.log('Start button clicked');
            if (!isRecording) {
                finalTranscript = '';
                try {
                    recognition.start();
                    console.log('Recognition started');
                    isRecording = true;
                    startBtn.classList.add('active');
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                } catch (e) {
                    console.error('Error starting recognition:', e);
                    alert('Error starting recognition: ' + e.message);
                }
            }
        };

        stopBtn.onclick = function() {
            console.log('Stop button clicked');
            if (isRecording) {
                try {
                    recognition.stop();
                    console.log('Recognition stopped');
                    isRecording = false;
                    startBtn.classList.remove('active');
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                } catch (e) {
                    console.error('Error stopping recognition:', e);
                }
            }
        };

        saveBtn.onclick = function() {
            console.log('Save button clicked');
            const noteText = transcriptDiv.innerText.trim();
            if (noteText === '') {
                alert('Please record or type a note first');
                return;
            }

            fetch('/save_note', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ note: noteText })
            })
            .then(res => res.json())
            .then(data => {
                console.log('Note saved:', data);
                // Create and display the new note
                createNoteCard(data);
                
                // Clear the transcript
                finalTranscript = '';
                transcriptDiv.innerText = '';
            })
            .catch(error => {
                console.error('Error saving note:', error);
                alert('Failed to save note. Please try again.');
            });
        };
        
        // Initialize button states
        stopBtn.disabled = true;
    </script>
     <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize Feather Icons
        feather.replace();
    </script>
</body>
</html>